# -*-Python-*-

import ddsp
import ddsp.training

# Training dataset and model.
train.dataset_provider = @data.SoloInstrument()
data.SoloInstrument.file_pattern = '/path/to/dataset*.tfrecord'

train.model = @model.Model()

# =======
# Network
# =======

# Preprocessor
model.Model.preprocessor = @preprocessing.DefaultPreprocessor()
preprocessing.DefaultPreprocessor.time_steps = 1000

# Encoder
model.Model.encoder = None

# Decoder
model.Model.decoder = @decoders.RnnFcDecoder()
decoders.RnnFcDecoder.rnn_channels = 512
decoders.RnnFcDecoder.rnn_type = 'gru'
decoders.RnnFcDecoder.ch = 512
decoders.RnnFcDecoder.layers_per_stack = 3
decoders.RnnFcDecoder.output_splits = (('amps', 1),
                                       ('harmonic_distribution', 60),
                                       ('noise_magnitudes', 65))


# =================
# Signal Processors
# =================

# ProcessorGroup
model.Model.processor_group = @processors.ProcessorGroup()

processors.ProcessorGroup.dag = [
  (@additive/synths.Additive(),
    ['amps', 'harmonic_distribution', 'f0_hz']),
  (@noise/synths.FilteredNoise(),
    ['noise_magnitudes']),
  (@add/processors.Add(),
    ['noise/signal', 'additive/signal']),
  (@reverb/effects.FixedReverb(),
    ['add/signal']),
  (@add2/processors.Add(),
    ['add/signal', 'reverb/signal']),
]

# Additive Synthesizer
additive/synths.Additive.name = 'additive'
additive/synths.Additive.n_samples = 64000
additive/synths.Additive.sample_rate = 16000
additive/synths.Additive.normalize_below_nyquist = True
additive/synths.Additive.amp_scale_fn = @core.exp_sigmoid

# Filtered Noise Synthesizer
noise/synths.FilteredNoise.name = 'noise'
noise/synths.FilteredNoise.n_samples = 64000
noise/synths.FilteredNoise.window_size = 0
noise/synths.FilteredNoise.amp_scale_fn = @core.exp_sigmoid

# Add
add/processors.Add.name = 'add'

# Reverb
reverb/effects.FixedReverb.name = 'reverb'
reverb/effects.FixedReverb.reverb_length = 64000

# Add2
add2/processors.Add.name = 'add2'


# ======
# Losses
# ======

model.Model.losses = [
    @losses.SpectralLoss(),
]
losses.SpectralLoss.loss_type = 'L1'
losses.SpectralLoss.mag_weight = 1.0
losses.SpectralLoss.logmag_weight = 1.0
